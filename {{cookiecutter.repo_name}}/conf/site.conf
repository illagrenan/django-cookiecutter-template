#######################################################################
#
# This is the main Nginx configuration file
# for project "{{ cookiecutter.project_name }}".
#
#
# More information about the configuration options is available on
#   * the English wiki - http://wiki.nginx.org/Main
#
#######################################################################

upstream {{ cookiecutter.repo_name }}_gunicorn_server {
  # fail_timeout=0 means we always retry an upstream even if it failed
  # to return a good HTTP response (in case the Unicorn master nukes a
  # single worker for timing out).

  server unix:{{ cookiecutter.deploy_path }}{{ cookiecutter.repo_name }}/{{ cookiecutter.app_subdirectory_in_deploy_path }}gunicorn.sock fail_timeout=0;
}

server {
    #---------------------------------------------------------------------------------------------------
    # Enable ngx_pagespeed
    # See: https://github.com/pagespeed/ngx_pagespeed/#how-to-use
    # See: http://xmodulo.com/2014/01/speed-nginx-web-server-pagespeed.html
    #---------------------------------------------------------------------------------------------------


    pagespeed on;

    # PageSpeed Admin
    pagespeed StatisticsPath /ngx_pagespeed_statistics;
    pagespeed MessagesPath /ngx_pagespeed_message;
    pagespeed ConsolePath /pagespeed_console;
    pagespeed AdminPath /pagespeed_admin;

    # ngx_pagespeed_statistics
    # ngx_pagespeed_global_statistics
    # ngx_pagespeed_message
    # pagespeed_console
    # pagespeed_admin
    location ^~ /(pagespeed_|ngx_pagespeed_) {
          allow 127.0.0.1;
          allow 89.176.36.74;
          allow 194.228.13.139;
          deny all;
    }

    pagespeed Domain *.{{ cookiecutter.domain_name }};
    pagespeed MapOriginDomain "http://localhost" "http://unix:{{ cookiecutter.deploy_path }}{{ cookiecutter.repo_name }}/{{ cookiecutter.app_subdirectory_in_deploy_path }}gunicorn.sock";

    pagespeed FileCachePath /tmp/ngx_pagespeed_cache/{{ cookiecutter.repo_name }};  # Use tmpfs for best results.


    pagespeed LoadFromFile "^https?://www.{{ cookiecutter.domain_name }}/static/"
                            "{{ cookiecutter.deploy_path }}{{ cookiecutter.repo_name }}/{{ cookiecutter.app_subdirectory_in_deploy_path }}data/static/";

    # enable CoreFilters
    pagespeed RewriteLevel CoreFilters;

    # disable particular filter(s) in CoreFilters
    # pagespeed DisableFilters rewrite_images;

    # enable additional filter(s) selectively
    pagespeed EnableFilters collapse_whitespace;
    pagespeed EnableFilters lazyload_images;
    pagespeed EnableFilters insert_dns_prefetch;

    #  Ensure requests for pagespeed optimized resources go to the pagespeed
    #  handler and no extraneous headers get set.
    location ~ "\.pagespeed\.([a-z]\.)?[a-z]{2}\.[^.]{10}\.[^.]+" { add_header "" ""; }
    location ~ "^/ngx_pagespeed_static/" { }
    location ~ "^/ngx_pagespeed_beacon$" { }

    pagespeed Statistics on;
    pagespeed StatisticsLogging on;
    pagespeed LogDir /var/log/pagespeed;

    #---------------------------------------------------------------------------------------------------
    # Basic options
    #---------------------------------------------------------------------------------------------------

    listen   80;
    server_name www.{{ cookiecutter.domain_name }} {{ cookiecutter.domain_name }};

    # Uncomment to enable basic auth
    # auth_basic "Restricted";
    # auth_basic_user_file {{ cookiecutter.deploy_path }}{{ cookiecutter.repo_name }}/{{ cookiecutter.app_subdirectory_in_deploy_path }}.htpasswd;

    client_max_body_size 4G;

    access_log {{ cookiecutter.deploy_path }}{{ cookiecutter.repo_name }}/{{ cookiecutter.app_subdirectory_in_deploy_path }}log/nginx-access.log;
    error_log  {{ cookiecutter.deploy_path }}{{ cookiecutter.repo_name }}/{{ cookiecutter.app_subdirectory_in_deploy_path }}log/nginx-error.log;

    location /static/ {
        alias   {{ cookiecutter.deploy_path }}{{ cookiecutter.repo_name }}/{{ cookiecutter.app_subdirectory_in_deploy_path }}data/static/;
        # expires max;
        access_log off;
        add_header Cache-Control "public";
    }

    location /robots.txt {
        alias   {{ cookiecutter.deploy_path }}{{ cookiecutter.repo_name }}/{{ cookiecutter.app_subdirectory_in_deploy_path }}data/static/robots.txt;
    }

    location /humans.txt {
        alias   {{ cookiecutter.deploy_path }}{{ cookiecutter.repo_name }}/{{ cookiecutter.app_subdirectory_in_deploy_path }}data/static/humans.txt;
    }

    location ~ ^/favicon.(\w*)$ {
        alias   {{ cookiecutter.deploy_path }}{{ cookiecutter.repo_name }}/{{ cookiecutter.app_subdirectory_in_deploy_path }}data/static/favicon.$1;
    }

    location /media/ {
        alias   {{ cookiecutter.deploy_path }}{{ cookiecutter.repo_name }}/{{ cookiecutter.app_subdirectory_in_deploy_path }}data/media/;
    }

    #---------------------------------------------------------------------------------------------------

    #---------------------------------------------------------------------------------------------------
    # SSL configuration
    # See:
    #       https://filip-prochazka.com/blog/nginx-https-spdy-hsts-security
    #       http://security.stackexchange.com/questions/79519/ssl-tls-how-to-fix-chain-issues-contains-anchor
    #---------------------------------------------------------------------------------------------------
    # Remove default_server if you have more SSL-secured hosts on one IP
    listen                      443 default ssl http2;

    ssl                         on;
	ssl_certificate 			/etc/letsencrypt/live/{{ cookiecutter.domain_name }}/fullchain.pem;
	ssl_certificate_key 		/etc/letsencrypt/live/{{ cookiecutter.domain_name }}/privkey.pem;
    ssl_dhparam                 {{ cookiecutter.deploy_path }}{{ cookiecutter.repo_name }}/{{ cookiecutter.app_subdirectory_in_deploy_path }}data/certs/dhparam2048.pem;

    include                     {{ cookiecutter.deploy_path }}{{ cookiecutter.repo_name }}/{{ cookiecutter.app_subdirectory_in_deploy_path }}conf/nginx/directives/ssl.conf;
    include                     {{ cookiecutter.deploy_path }}{{ cookiecutter.repo_name }}/{{ cookiecutter.app_subdirectory_in_deploy_path }}conf/nginx/directives/ssl-stapling.conf;

    #---------------------------------------------------------------------------------------------------

    #---------------------------------------------------------------------------------------------------
    # Directives
    #---------------------------------------------------------------------------------------------------

    include                     {{ cookiecutter.deploy_path }}{{ cookiecutter.repo_name }}/{{ cookiecutter.app_subdirectory_in_deploy_path }}conf/nginx/directives/cache-file-descriptors.conf;
    include                     {{ cookiecutter.deploy_path }}{{ cookiecutter.repo_name }}/{{ cookiecutter.app_subdirectory_in_deploy_path }}conf/nginx/directives/extra-security.conf;
    include                     {{ cookiecutter.deploy_path }}{{ cookiecutter.repo_name }}/{{ cookiecutter.app_subdirectory_in_deploy_path }}conf/nginx/directives/spdy.conf;
    include                     {{ cookiecutter.deploy_path }}{{ cookiecutter.repo_name }}/{{ cookiecutter.app_subdirectory_in_deploy_path }}conf/nginx/directives/x-ua-compatible.conf;

    include                     {{ cookiecutter.deploy_path }}{{ cookiecutter.repo_name }}/{{ cookiecutter.app_subdirectory_in_deploy_path }}conf/nginx/location/protect-system-files.conf;

    #---------------------------------------------------------------------------------------------------

    #---------------------------------------------------------------------------------------------------
    # Proxy for Gunicorn
    # See: http://michal.karzynski.pl/blog/2013/06/09/django-nginx-gunicorn-virtualenv-supervisor/
    #---------------------------------------------------------------------------------------------------

    location / {
        # an HTTP header important enough to have its own Wikipedia entry:
        #   http://en.wikipedia.org/wiki/X-Forwarded-For
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;

        # pass the Host: header from the client right along so redirects
        # can be set properly within the Rack application
        proxy_set_header Host $http_host;

        # we don't want nginx trying to do something clever with
        # redirects, we set the Host: header above already.
        proxy_redirect off;

        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-Proto $scheme;

        # Try to serve static files from nginx, no point in making an
        # *application* server like Unicorn/Rainbows! serve static files.
        if (!-f $request_filename) {
            proxy_pass http://{{ cookiecutter.repo_name }}_gunicorn_server;
            break;
        }
    }

    #---------------------------------------------------------------------------------------------------
}
